##Below fields extractions have been moved from [XmlWinEventLog:Microsoft-Windows-Sysmon/Operational]
[source::XmlWinEventLog:Microsoft-Windows-Sysmon/Operational]
#SEDCMD-pwd_rule1 = s/ -pw ([^\s\<])+/ -pw ***MASK***/g
REPORT-sysmon = sysmon-eventid,sysmon-version,sysmon-level,sysmon-task,sysmon-opcode,sysmon-keywords,sysmon-created,sysmon-record,sysmon-correlation,sysmon-channel,sysmon-computer,sysmon-sid,sysmon-data,sysmon-md5,sysmon-sha1,sysmon-sha256,sysmon-imphash,sysmon-hashes,sysmon-filename,sysmon-registry,sysmon-dns-record-data,sysmon-dns-ip-data

FIELDALIAS-src_ip = SourceIp AS src_ip
FIELDALIAS-src_host = SourceHostname AS src_host
EVAL-src = if(isnotnull(SourceHostname),SourceHostname,SourceIp)
FIELDALIAS-src_port = SourcePort AS src_port
FIELDALIAS-app = Image AS app
FIELDALIAS-dest_ip = DestinationIp AS dest_ip
FIELDALIAS-dest_host = DestinationHostname AS dest_host
EVAL-dest = case(EventCode=="3" AND isnotnull(DestinationHostname),DestinationHostname,EventCode=="3",DestinationIp,EventCode=="1" OR EventCode == "11" OR EventCode == "12" OR EventCode == "13" OR EventCode == "14", Computer)
FIELDALIAS-dest_port = DestinationPort AS dest_port
EVAL-direction = if(Initiated=="true","outbound","inbound")
FIELDALIAS-dvc = Computer AS dvc
FIELDALIAS-transport = Protocol AS transport
EVAL-protocol = if(Initiated=="true",DestinationPortName,SourcePortName)
FIELDALIAS-session_id = ProcessGuid AS session_id
EVAL-vendor_product = "Microsoft Sysmon"
FIELDALIAS-cmdline = CommandLine AS cmdline

#Common fieldnames for Registry, Process, FileSystem Node in Endpoint Datamodel
#  https://docs.splunk.com/Documentation/CIM/4.19.0/User/Endpoint
EVAL-action = case(EventCode=="1","allowed",EventCode=="12" AND EventType=="CreateKey","created",EventCode=="12" AND (EventType=="DeleteKey" OR EventType=="DeleteValue") ,"deleted",EventCode=="13" AND EventType=="SetValue","modified",EventCode=="11" AND EventDescription=="File Created","created")

#Ports Node
EVAL-creation_time = case(EventCode=="3",UtcTime)
EVAL-state = case(EventCode=="3", "listening")

#Processes Node
# https://docs.splunk.com/Documentation/CIM/4.19.0/User/Endpoint#Processes
EVAL-parent_process_exec = case(EventCode=="1" OR EventCode=="2" OR EventCode=="3" OR EventCode=="5" OR EventCode=="7" OR EventCode=="9" OR EventCode=="11" OR EventCode=="12" OR EventCode=="13" OR EventCode=="14" OR EventCode=="15" OR EventCode=="17" OR EventCode=="18", replace(ParentImage,"(.*\\\)(?=.*(\.\w*)$|(\w+)$)",""),1==1,"")
FIELDALIAS-parent_process_id = ParentProcessId AS parent_process_id
FIELDALIAS-parent_process_guid = ParentProcessGuid AS parent_process_guid
FIELDALIAS-parent_process_path = ParentImage AS parent_process_path
FIELDALIAS-process_current_directory = CurrentDirectory AS process_current_directory
EVAL-process_exec = case(EventCode=="1" OR EventCode=="2" OR EventCode=="3" OR EventCode=="5" OR EventCode=="7" OR EventCode=="9" OR EventCode=="11" OR EventCode=="12" OR EventCode=="13" OR EventCode=="14" OR EventCode=="15" OR EventCode=="17" OR EventCode=="18" OR EventCode="22", replace(Image,"(.*\\\)(?=.*(\.\w*)$|(\w+)$)",""),EventCode=="6","System",EventCode=="8" OR EventCode=="10",replace(SourceImage,"(.*\\\)(?=.*(\.\w*)$|(\w+)$)",""),1==1,"")
FIELDALIAS-process_hash = Hashes AS process_hash
FIELDALIAS-process_guid = ProcessGuid AS process_guid
FIELDALIAS-process_id = ProcessId AS process_id
FIELDALIAS-process_integrity_level = IntegrityLevel AS process_integrity_level
FIELDALIAS-process_path = Image AS process_path
FIELDALIAS-user_id = UserID AS user_id
REPORT-user_for_sysmon = User_as_user
FIELDALIAS-parent_process = ParentCommandLine AS parent_process
EVAL-parent_process_name = case(EventCode=="1" OR EventCode=="2" OR EventCode=="3" OR EventCode=="5" OR EventCode=="7" OR EventCode=="9" OR EventCode=="11" OR EventCode=="12" OR EventCode=="13" OR EventCode=="14" OR EventCode=="15" OR EventCode=="17" OR EventCode=="18", replace(ParentImage,"(.*\\\)(?=.*(\.\w*)$|(\w+)$)",""),1==1,"")
FIELDALIAS-process = CommandLine AS process
EVAL-process_name = case(EventCode=="1" OR EventCode=="2" OR EventCode=="3" OR EventCode=="5" OR EventCode=="7" OR EventCode=="9" OR EventCode=="11" OR EventCode=="12" OR EventCode=="13" OR EventCode=="14" OR EventCode=="15" OR EventCode=="17" OR EventCode=="18" OR EventCode="22", replace(Image,"(.*\\\)(?=.*(\.\w*)$|(\w+)$)",""),EventCode=="6","System",EventCode=="8" OR EventCode=="10",replace(SourceImage,"(.*\\\)(?=.*(\.\w*)$|(\w+)$)",""),1==1,"")

#Filesystem Node
# https://docs.splunk.com/Documentation/CIM/4.19.0/User/Endpoint#Filesystem
FIELDALIAS-file_path = TargetFilename AS file_path
FIELDALIAS-file_create_time = CreationUtcTime AS file_create_time

#Fields for ChangeAnalysis DM (old field names)
# https://docs.splunk.com/Documentation/CIM/4.19.0/User/Change
EVAL-object_category = case(EventCode=="11" OR EventCode=="2", "file", EventCode=="12" OR EventCode=="13" OR EventCode="14", "registry", EventCode=="19" OR EventCode=="20" OR EventCode="21", "wmi")
EVAL-object_path = case(EventCode=="12" OR EventCode=="13", TargetObject, EventCode=="14", NewName)
LOOKUP-eventcode = eventcode EventCode OUTPUTNEW EventDescription EventDescription AS signature
FIELDALIAS-signature_id = EventCode AS signature_id
FIELDALIAS-eventid = EventCode AS EventID

#Registry Node
# https://docs.splunk.com/Documentation/CIM/4.19.0/User/Change
EVAL-registry_path = case(EventCode=="12" OR EventCode=="13" OR EventCode=="14", TargetObject)
EVAL-registry_value_name = case(EventCode=="13", Details)
EVAL-registry_key_name = case(EventCode=="12" OR EventCode=="13" OR EventCode=="14",replace(TargetObject,".+\\\\",""))

#DNS Node
# https://docs.splunk.com/Documentation/CIM/4.19.0/User/NetworkResolutionDNS
FIELDALIAS-query = QueryName AS query
FIELDALIAS-replycode = QueryStatus AS reply_code_id

## To provide backward compatibility for WinEventLog and XmlWinEventLog data
## These will be deprecated in future
[XmlWinEventLog:Microsoft-Windows-Sysmon/Operational]
rename = xmlwineventlog

###########################################################
# SYSMON EVENT ID 255 : Error report
# DATA: UtcTime, ID, Description


###########################################################
# SYSMON EVENT ID 1 : Process Create [ProcessCreate]
# DATA: RuleName, UtcTime, ProcessGuid, ProcessId, Image, FileVersion, Description, Product, Company, OriginalFileName, CommandLine, CurrentDirectory, User, LogonGuid, LogonId, TerminalSessionId, IntegrityLevel, Hashes, ParentProcessGuid, ParentProcessId, ParentImage, ParentCommandLine


###########################################################
# SYSMON EVENT ID 2 : File creation time changed [FileCreateTime]
# DATA: RuleName, UtcTime, ProcessGuid, ProcessId, Image, TargetFilename, CreationUtcTime, PreviousCreationUtcTime


###########################################################
# SYSMON EVENT ID 3 : Network connection detected [NetworkConnect]
# DATA: RuleName, UtcTime, ProcessGuid, ProcessId, Image, User, Protocol, Initiated, SourceIsIpv6, SourceIp, SourceHostname, SourcePort, SourcePortName, DestinationIsIpv6, DestinationIp, DestinationHostname, DestinationPort, DestinationPortName


###########################################################
# SYSMON EVENT ID 4 : Sysmon service state changed
# DATA: UtcTime, State, Version, SchemaVersion


###########################################################
# SYSMON EVENT ID 5 : Process terminated [ProcessTerminate]
# DATA: RuleName, UtcTime, ProcessGuid, ProcessId, Image


###########################################################
# SYSMON EVENT ID 6 : Driver loaded [DriverLoad]
# DATA: RuleName, UtcTime, ImageLoaded, Hashes, Signed, Signature, SignatureStatus


###########################################################
# SYSMON EVENT ID 7 : Image loaded [ImageLoad]
# DATA: RuleName, UtcTime, ProcessGuid, ProcessId, Image, ImageLoaded, FileVersion, Description, Product, Company, OriginalFileName, Hashes, Signed, Signature, SignatureStatus


###########################################################
# SYSMON EVENT ID 8 : CreateRemoteThread detected [CreateRemoteThread]
# DATA: RuleName, UtcTime, SourceProcessGuid, SourceProcessId, SourceImage, TargetProcessGuid, TargetProcessId, TargetImage, NewThreadId, StartAddress, StartModule, StartFunction


###########################################################
# SYSMON EVENT ID 9 : RawAccessRead detected [RawAccessRead]
# DATA: RuleName, UtcTime, ProcessGuid, ProcessId, Image, Device


###########################################################
# SYSMON EVENT ID 10 : Process accessed [ProcessAccess]
# DATA: RuleName, UtcTime, SourceProcessGUID, SourceProcessId, SourceThreadId, SourceImage, TargetProcessGUID, TargetProcessId, TargetImage, GrantedAccess, CallTrace


###########################################################
# SYSMON EVENT ID 11 : File created [FileCreate]
# DATA: RuleName, UtcTime, ProcessGuid, ProcessId, Image, TargetFilename, CreationUtcTime


###########################################################
# SYSMON EVENT ID 12 : Registry object added or deleted [RegistryEvent]
# DATA: RuleName, EventType, UtcTime, ProcessGuid, ProcessId, Image, TargetObject


###########################################################
# SYSMON EVENT ID 13 : Registry value set [RegistryEvent]
# DATA: RuleName, EventType, UtcTime, ProcessGuid, ProcessId, Image, TargetObject, Details


###########################################################
# SYSMON EVENT ID 14 : Registry object renamed [RegistryEvent]
# DATA: RuleName, EventType, UtcTime, ProcessGuid, ProcessId, Image, TargetObject, NewName


###########################################################
# SYSMON EVENT ID 15 : File stream created [FileCreateStreamHash]
# DATA: RuleName, UtcTime, ProcessGuid, ProcessId, Image, TargetFilename, CreationUtcTime, Hash, Contents


###########################################################
# SYSMON EVENT ID 16 : Sysmon config state changed []
# DATA: UtcTime, Configuration, ConfigurationFileHash


###########################################################
# SYSMON EVENT ID 17 : Pipe Created [PipeEvent]
# DATA: RuleName, EventType, UtcTime, ProcessGuid, ProcessId, PipeName, Image


###########################################################
# SYSMON EVENT ID 18 : Pipe Connected [PipeEvent]
# DATA: RuleName, EventType, UtcTime, ProcessGuid, ProcessId, PipeName, Image


###########################################################
# SYSMON EVENT ID 19 : WmiEventFilter activity detected [WmiEvent]
# DATA: RuleName, EventType, UtcTime, Operation, User, EventNamespace, Name, Query


###########################################################
# SYSMON EVENT ID 20 : WmiEventConsumer activity detected [WmiEvent]
# DATA: RuleName, EventType, UtcTime, Operation, User, Name, Type, Destination


###########################################################
# SYSMON EVENT ID 21 : WmiEventConsumerToFilter activity detected [WmiEvent]
# DATA: RuleName, EventType, UtcTime, Operation, User, Consumer, Filter


###########################################################
# SYSMON EVENT ID 22 : Dns query [DnsQuery]
# DATA: RuleName, UtcTime, ProcessGuid, ProcessId, QueryName, QueryStatus, QueryResults, Image


###########################################################
# SYSMON EVENT ID 23 : File Delete archived [FileDelete]
# DATA: RuleName, UtcTime, ProcessGuid, ProcessId, User, Image, TargetFilename, Hashes, IsExecutable, Archived


###########################################################
# SYSMON EVENT ID 24 : Clipboard changed [ClipboardChange]
# DATA: RuleName, UtcTime, ProcessGuid, ProcessId, Image, Session, ClientInfo, Hashes, Archived


###########################################################
# SYSMON EVENT ID 25 : Process Tampering [ProcessTampering]
# DATA: RuleName, UtcTime, ProcessGuid, ProcessId, Image, Type


###########################################################
# SYSMON EVENT ID 26 : File Delete logged [FileDeleteDetected]
# DATA: RuleName, UtcTime, ProcessGuid, ProcessId, User, Image, TargetFilename, Hashes, IsExecutable

# Endpoint:FileSystem
EVAL-action = case(EventCode=="26","deleted")
FIELDALIAS-dest = Computer AS dest
FIELDALIAS-file_access_time = UtcTime AS file_access_time
FIELDALIAS-file_hash = Hashes AS file_hash
FIELDALIAS-file_modify_time = UtcTime AS file_modify_time
EVAL-file_name = replace(TargetFilename,"(.*\\\)(?=.*(\.\w*)$|(\w+)$)","")
FIELDALIAS-file_path = TargetFilename AS file_path
FIELDALIAS-process_guid = ProcessGuid as process_guid
FIELDALIAS-process_id = ProcessId as process_id
FIELDALIAS-user = User as user
EVAL-vendor_product = "Microsoft Sysmon"



